---
title: "Northern Ireland Greenhouse Gas Inventory 1990-2022"
output:
  flexdashboard::flex_dashboard:
        orientation: columns
        css: "style.css"
logo: "images/A4_DAERA_Logo_White_Out.png"
        
    
    
---

<!--html_preserve-->
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KF6WGSG');</script>
<!-- End Google Tag Manager -->
<!--/html_preserve-->



```{r setup, include=FALSE}

if(!require(pacman)) install.packages("pacman") 
if(!require(crosstalk))install.packages("crosstalk")


# Loading the required packages . data.table added to increase load
pacman::p_load(
  "flexdashboard", "knitr", "crosstalk", "DT", "tidyverse", "plotly",
  "stringr", "reshape2", "readxl", "dplyr", "reactable", "formattable", 
  "base64enc", "png", "patchwork", "devtools", "htmltools", "lubridate", "kableExtra",
  "data.table"
  )

# READ IN THE DATA


GHG_ALL <- read_excel("FlatOutput_DAGHGI_1990-2022.xlsx") %>%
  mutate(
        EmissionYear = case_when(
        EmissionYear == "BaseYear" ~ "1989", 
        TRUE ~ EmissionYear
        ),
           EmissionYear = as.numeric(EmissionYear)
        )


# TIDY THE DATA UP

#Add Grouped IPCC column
#IPCCgroups <- read_excel("C://Users/2345940/Desktop/dashboard/IPCC Groupings for html and powerBI dashboards.xlsx") %>%
 # mutate(
#    IPCC_code = sub("_.*", "", `IPCC from 2018 inventory`),
#    IPCC_code = sub(" .*", "", IPCC_code)
#    ) %>%
#  select("IPCC_code", "Grouped-Sector-powerBI") %>%
##  filter(!is.na(IPCC_code)) %>%
#  distinct()

# Convert GHG_ALL and IPCCgroups to data.table
#setDT(GHG_ALL)
#setDT(IPCCgroups)

# Perform an efficient left join using data.table syntax
#GHG_ALL <- GHG_ALL[IPCCgroups, on = "IPCC_code"]

# Intermediate result to preserve additional cols pre-group
GHG_ALL <- GHG_ALL %>%
  select(-Timestamp) %>%
  filter(ConvertTo == "GWP CO2_AR5" & TESS1 != "International aviation and shipping")

GHG_PROJ <- read_excel("GHG Projections Data.xlsx")
PROJ_ACTUAL <- GHG_ALL %>%
  group_by(Pollutant, SourceName, EmissionYear, RegionName, IPCC_code, NCFormat) %>%
  summarise(Emission = sum(Emission), .groups = 'drop') %>%
  mutate(Mt = Emission / 1000)
regions <- c("Northern Ireland", "England", "Scotland", "Wales", "Unallocated")
frames <- c("PROJ_ACTUAL_NI", "PROJ_ACTUAL_ENG", "PROJ_ACTUAL_SCOT", "PROJ_ACTUAL_WAL", "PROJ_ACTUAL_UNALL")

for (i in 1:length(regions)) {
  assign(frames[i], filter(PROJ_ACTUAL, RegionName == regions[i]))
}

# Summarise keeping necessary grouped variables
GHG_ALL <- GHG_ALL %>%
  group_by(Pollutant, SourceName, EmissionYear, RegionName, IPCC_code, TESS1, TESS2, TESS3, NCFormat) %>%
  summarise(Emission = sum(Emission), .groups = 'drop') %>%
  mutate(Mt = Emission / 1000)

print(colnames(GHG_ALL))
# Filter data by region for performance
regions <- c("Northern Ireland", "England", "Scotland", "Wales", "Unallocated")
frames <- c("GHG_NI", "GHG_ENG", "GHG_SCOT", "GHG_WAL", "GHG_UNALL")

for (i in 1:length(regions)) {
  assign(frames[i], filter(GHG_ALL, RegionName == regions[i]))
}

# Define current year and other shared variables early
currentYear <- max(GHG_NI$EmissionYear)
years <- unique(GHG_NI$EmissionYear)

sectorColours <- data.frame(
  TESS1 = sort(unique(GHG_NI$TESS1)),
  colour = c("#197e84", "#831d5c", "#7e749d", "#819dcb",
             "#ee706f", "#009b3e", "#b5bc47", "#043c54")
)
# Helper functions
wrap.it <- function(x, len) {
  sapply(x, function(y) paste(strwrap(y, len), collapse = "\n"), USE.NAMES = FALSE)
}

wrap.labels <- function(x, len) {
  if (is.list(x)) {
    lapply(x, wrap.it, len)
  } else {
    wrap.it(x, len)
  }
}
```


HOME {data-icon="ion-home"}
=======================================================================



Column {data-width=400}
-----------------------------------------------------------------------

### **HISTORIC EMISSIONS**

```{r}
#Aggregate by year, sector, PollutantSum
PollutantSum <- GHG_NI %>%
  filter(EmissionYear > 1989) %>%
  group_by(EmissionYear) %>%
  summarise(sumCO2 = sum(`Emission`)/1000, .gorups ='drop')

# Calculate CO2 only data
CO2only <- GHG_NI %>%
  filter(EmissionYear > 1989, Pollutant == "CO2") %>%
  group_by(EmissionYear) %>%
  summarise(sumCO2 = sum(Emission) / 1000, .groups = 'drop')

#Pre and post 1997 data
PollutantSum_split <- PollutantSum %>%
  mutate(pre1997 = ifelse(EmissionYear < 1997, sumCO2, NA),
         post1997 = ifelse(EmissionYear > 1997, sumCO2, NA))

CO2only_split <- CO2only %>%
  mutate(pre1997 = ifelse(EmissionYear < 1997, sumCO2, NA),
        post1997 = ifelse(EmissionYear > 1997, sumCO2, NA))

# Colours
green <- "#009b3e"
blue <- "#1c5d97"

#Plot graph
PollutantSum_split %>%
  plot_ly(x = ~EmissionYear, y = ~post1997, name = "",
          type = "scatter", mode = "lines",
          line = list(width = 5, color = "#009b3e"),
          hovertemplate = paste('Total greenhouse gas emissions',
                                '<br><b>%{x}</b>: %{y:.2f} MtCO\u2082e')) %>%
  add_trace(y = CO2only_split$post1997,
            line = list(width = 5, color = "#1c5d97"),
            hovertemplate = paste('CO\u2082 gas emissions',
                                '<br><b>%{x}</b>: %{y:.2f} MtCO\u2082e')) %>%
  add_trace(y = ~pre1997, mode="markers",
            marker = list(size = 15, color = "#009b3e"),
            line = list(width = 0, color = "white"),
            hovertemplate = paste('Total greenhouse gas emissions',
                               '<br><b>%{x}</b>: %{y:.2f} MtCO\u2082e')) %>%
  add_trace(y = CO2only_split$pre1997, mode = "markers",
            marker = list(size = 15, color = "#1c5d97"),
            line = list(width = 0, color = "white"),
            hovertemplate = paste('CO\u2082 gas emissions',
                                '<br><b>%{x}</b>: %{y:.2f} MtCO\u2082e')) %>%
  layout(
    xaxis = list(
      title = "",
      showgrid = FALSE,
      linecolor = "Black",
      linewidth = 4,
      ticks = "inside",
      tickwidth = 4,
      tickcolor = "Black",
      tickangle = 0,
      tickfont = list(color='Black', size=14),
      range = c(1989, currentYear)),
    yaxis = list(
      title = "",
      showgrid = FALSE,
      showline = TRUE,
      linecolor = "Black",
      linewidth = 4,
      ticks = "inside",
      tickwidth = 4,
      tickcolor = "Black",
      tickfont = list(color='Black', size=14),
      range = c(0, max(PollutantSum$sumCO2)+3)
      ),
    hovermode = "x unified",
    annotations = list(
      list(x = 0, y = 1, text = "Greenhouse gas\nemissions\nMtCO\u2082e*", 
           showarrow = F, xref= "paper", yref="paper", 
           xanchor = "center", yanchor="bottom",
           font = list(size = 15)),
      list(x = 1, y = 0.05, text = "*MtCO\u2082e = million tonnes of CO\u2082 equivalent",
       showarrow = F, xref= "paper", yref="paper", 
       xanchor = "right", yanchor="bottom",
       font = list(size = 15))),
    margin = list(t = 75)) %>%
  hide_legend()  %>%
    config(displaylogo = FALSE)

```
### **Progress against draft ‘Programme for Government’ Wellbeing Framework**

```{r}

# Set PfG Baseline Year
PfGBaselineYear <- 2019


# Calculate the current year emissions and the baseline year emissions in Megatons and creates a data frame
pfG <- GHG_NI %>%
  filter(EmissionYear %in% c(currentYear, PfGBaselineYear)) %>%
  group_by(EmissionYear) %>%
  summarise(Emission = round(sum(Emission) / 1000, 1), .groups = 'drop')

# Calculate the difference in Emissions from the Baseline Year to the Current Year
pfGChange <- pfG$Emission[pfG$EmissionYear == currentYear] - pfG$Emission[pfG$EmissionYear == PfGBaselineYear]
# Calculate the percentage difference in Emissions from the Baseline Year to the Current Year
pfGChangePercent <- (pfGChange / pfG$`Emission`[pfG$EmissionYear == PfGBaselineYear]) * 100
# Calculate the level of significance to determine if an actual change has occurred between the baseline and current year
pfGSigChange <- currentYear - PfGBaselineYear

# IF statement to determine the background image and accompanying text depending on the percentage change compared with the required level of significance
if(PfGBaselineYear == currentYear) {
  pfgInfo <- "images/PfgNoChange.png"
  pfgText1 <- ""
  pfgText2 <- ""
} else if(pfGChangePercent >= (pfGSigChange * -1) & pfGChangePercent <= pfGSigChange) {
  pfgInfo <- "images/PfgNoChange.png"
pfgText1 <- "No"
  pfgText2 <- "change"
} else if (pfGChangePercent < (pfGSigChange * -1)) {
  pfgInfo <- "images/PfgNoChange.png"
 pfgText1 <- ""
  pfgText2 <- ""
} else {
  pfgInfo <- "images/PfgIncreased.png"
  pfgText1 <- ""
  pfgText2 <- "Increased"
}

# GGplot to add the appropriate image, title, text and values for the baseline year and current year. Positioning, font types/sizes and colours are set in this code
ggplot() +
  theme_void() +
  annotate("text", label = "Climate Change", 
           x = 0, y = 0, hjust = 0.6, vjust = -6, colour = "white", size = 10, fontface = "bold") +
  annotate("text", label = "Total greenhouse gas", 
           x = 0, y = 0, hjust = 0.15, vjust = -2.2, colour = "white", size = 7, fontface = "bold") +
  annotate("text", label = "emissions in NI.", 
           x = 0, y = 0, hjust = 0.1, vjust = -0.8, colour = "white", size = 7, fontface = "bold") +
  annotate("text", label = bquote(.(pfG$`Emission`[pfG$EmissionYear == PfGBaselineYear]) ~ "MtCO"[2] * "e Baseline" ~ .(PfGBaselineYear)), 
           x = 0, y = 0, hjust = 0.4, vjust = 6, colour = "white", size = 8, fontface = "bold") +
  annotate("text", label = bquote(.(pfG$`Emission`[pfG$EmissionYear == currentYear]) ~ "MtCO"[2] * "e" ~ .(currentYear)), 
           x = 0, y = 0, hjust = 0.25, vjust = 7.2, colour = "white", size = 8, fontface = "bold") +
  annotate("text", label = pfgText1, 
           x = 0, y = 0, hjust = -7, vjust = -9, colour = "white", size = 6) +
  annotate("text", label = pfgText2, 
           x = 0, y = 0, hjust = -2.2, vjust = -8, colour = "white", size = 6)+
  inset_element(p = readPNG(pfgInfo, native = TRUE),
                left = 0, bottom = 0, right = 1, top = 1, on_top = FALSE)
  

```


column {data-width=400}
-----------------------------------------------------------------------

### **CHANGE IN EMISSIONS**  

```{r}

# Load dashboard/images used for plotting infographic
greenCloud <- "images/Green cloud.png"
blueCloud <- "images/Blue cloud.png"
greenArrowDown <- "images/Green arrow down.png"
blueArrowDown <- "images/Blue arrow down.png"
greenArrowUp <- "images/Green arrow up.png"
blueArrowUp <- "images/Blue arrow up.png"

# Create data frame of values needed for infogrpahic
co2Compare <- GHG_NI %>%
   # Filter for This year, last year and 1990
  filter(EmissionYear %in% c(1990, currentYear-1, currentYear)) %>%
  # Group by year and then sum CO2 Equiv
  group_by(EmissionYear) %>%
  summarise(Emission = sum(Emission), .groups = 'drop') %>%
  # Repeat above process for just CO2 pollutant and join to data
  left_join(GHG_NI %>%
      filter(EmissionYear %in% c(1990, currentYear-1, currentYear) & Pollutant == "CO2") %>%
      group_by(EmissionYear) %>%
      summarise(CO2 = sum(Emission), .groups = 'drop')) %>%
  # Divide figures by 1,000 to obtain Megatonne value and round to 1 dp
  mutate(`Emission` = round(`Emission` / 1000, 1),
         CO2 = round(CO2 / 1000, 1))

# Calculate percentage change 
pctCO2Equiv <-
  round((co2Compare$`Emission`[co2Compare$EmissionYear == currentYear-1] -
           co2Compare$`Emission`[co2Compare$EmissionYear == currentYear]) /
          co2Compare$`Emission`[co2Compare$EmissionYear == currentYear-1] * 100)

# Calculate percentage change in Emission equivalent of all greenhouse gases from 1990
pctCO2Equiv_1990 <-
  round((co2Compare$`Emission`[co2Compare$EmissionYear == 1990] -
           co2Compare$`Emission`[co2Compare$EmissionYear == currentYear]) /
          co2Compare$`Emission`[co2Compare$EmissionYear == 1990] * 100)

# Calculate percentage change in CO2 from last year
pctCO2 <-
  round((co2Compare$CO2[co2Compare$EmissionYear == currentYear-1] -
           co2Compare$CO2[co2Compare$EmissionYear == currentYear]) /
          co2Compare$CO2[co2Compare$EmissionYear == currentYear-1] * 100)

# Calculate percentage change in CO2 from 1990
pctCO2_1990 <-
  round((co2Compare$CO2[co2Compare$EmissionYear == 1990] -
           co2Compare$CO2[co2Compare$EmissionYear == currentYear]) /
          co2Compare$CO2[co2Compare$EmissionYear == 1990] * 100)

# Determine arrows for change based on percentage changes
greenArrow1 <- if (pctCO2Equiv < 0) greenArrowUp else greenArrowDown
pctCO2Equiv <- abs(pctCO2Equiv)

greenArrow2 <- if (pctCO2Equiv_1990 < 0) greenArrowUp else greenArrowDown
pctCO2Equiv_1990 <- abs(pctCO2Equiv_1990)

blueArrow1 <- if (pctCO2 < 0) blueArrowUp else blueArrowDown
pctCO2 <- abs(pctCO2)

blueArrow2 <- if (pctCO2_1990 < 0) blueArrowUp else blueArrowDown
pctCO2_1990 <- abs(pctCO2_1990)

# Colours
green <- "#009b3e"
blue <- "#1c5d97"

# Start with an empty ggplot
ggplot() +
  # Use an empty theme to remove axes
  theme_void() +
  # First all text captions are inserted and positioned using hjust and vjust
  # Left hand side
  # Text label "ThisYr Emissions"
  annotate("text", label = paste0(currentYear, " emissions"),
           x= 0, y = 0, hjust = 1.55, vjust = -6.1, colour = "white", size = 5) +
  # Text label "MTCO₂e"
  annotate("text", label = expression("MtCO"[2]*"e"),
           x= 0, y = 0, hjust = 2.6, vjust = -3.4, colour = "white", size = 5) +
  # Text label value of emissions in current year
  annotate("text", label = co2Compare$`Emission`[co2Compare$EmissionYear == currentYear],
           x= 0, y = 0, hjust = 3.25, vjust = -1.9, colour = "white", size = 7, fontface = "bold") +
  # Text label "LastYr-ThisYr % Change"
  annotate("text", label = paste0(currentYear-1, "-", currentYear, " % Change"),
           x= 0, y = 0, hjust = 1.1, vjust = 0, colour = green, size = 6) +
  # Text label % change value from last year
  annotate("text", label = paste0(pctCO2Equiv,"%"),
           x= 0, y = 0, hjust = 4.2, vjust = 3, colour = "white", size = 7) +
  # Text label "1990-ThisYr % Change"
  annotate("text", label = paste0("1990-", currentYear, " % Change"),
           x= 0, y = 0, hjust = 1.1, vjust = 7.0, colour = green, size = 6) +
  # Text label % change value from 1990
  annotate("text", label = paste0(pctCO2Equiv_1990,"%"),
           x= 0, y = 0, hjust = 3.15, vjust = 8.9, colour = "white", size = 7) +
  # Right hand side
  # Text label "ThisYr Emissions"
  annotate("text", label = paste0(currentYear, " emissions"),
           x= 0, y = 0, hjust = -0.55, vjust = -6.1, colour = "white", size = 5) +
  # Text label "MTCO₂e"
  annotate("text", label = expression("MtCO"[2]*"e"),
           x= 0, y = 0, hjust = -1.6, vjust = -3.4, colour = "white", size = 5) +
  # Text label value of emissions in current year
  annotate("text", label = co2Compare$CO2[co2Compare$EmissionYear == currentYear],
           x= 0, y = 0, hjust = -2.3, vjust = -1.9, colour = "white", size = 7, fontface = "bold") +
  # Text label "LastYr-ThisYr % Change"
  annotate("text", label = paste0(currentYear-1, "-", currentYear, " % Change"),
           x= 0, y = 0, hjust = -0.2, vjust = 0, colour = blue, size = 6) +
  # Text label % change value from last year
  annotate("text", label = paste0(pctCO2,"%"),
           x= 0, y = 0, hjust = -3.2, vjust = 3, colour = "white", size = 7) +
  # Text label "1990-ThisYr % Change"
  annotate("text", label = paste0("1990-", currentYear, " % Change"),
           x= 0, y = 0, hjust = -0.2, vjust = 7.0, colour = blue, size = 6) +
  # Text label % change value from 1990
  annotate("text", label = paste0(pctCO2_1990,"%"),
           x= 0, y = 0, hjust = -2.2, vjust = 8.9, colour = "white", size = 7) +
  # Total greenhouse gas emissions label
  annotate("text", label = "Total greenhouse gas",
           x= 0, y = 0, hjust = 1.2, vjust = -10, colour = green, angle = 0, size = 6) +
  annotate("text", label = "emissions",
           x= 0, y = 0, hjust = 2, vjust = -8.8, colour = green, angle = 0, size = 6) +
  # Carbon dioxide gas emissions label
  annotate("text", label = "Carbon dioxide",
           x= 0, y = 0, hjust = -0.4, vjust = -10, colour = blue, angle = 0, size = 6) +
  annotate("text", label = "emissions",
           x= 0, y = 0, hjust = -0.8, vjust = -8.8, colour = blue, angle = 0, size = 6) +
  # dashboard/images inserted and positioned
  inset_element(p = readPNG(greenCloud, native = TRUE),
                left = 0.05, bottom = 0.55, right = 0.45, top = 0.8, on_top = FALSE) +
  inset_element(p = readPNG(greenArrow1, native = TRUE),
                left = 0.05, bottom = 0.28, right = 0.45, top = 0.48, on_top = FALSE) +
  inset_element(p = readPNG(greenArrow2, native = TRUE),
                left = 0.05, bottom = 0.02, right = 0.45, top = 0.22, on_top = FALSE) +
  inset_element(p = readPNG(blueCloud, native = TRUE),
                left = 0.55, bottom = 0.55, right = 0.95, top = 0.8, on_top = FALSE) +
  inset_element(p = readPNG(blueArrow1, native = TRUE),
                left = 0.55, bottom = 0.28, right = 0.95, top = 0.48, on_top = FALSE) +
  inset_element(p = readPNG(blueArrow2, native = TRUE),
                left = 0.55, bottom = 0.02, right = 0.95, top = 0.22, on_top = FALSE)


  

```

### **EMISSIONS BY SECTOR `r currentYear`**
```{r}

# Create dataframe for homepage treemap. 
hometreemapdf <- GHG_NI %>%
  filter(EmissionYear == currentYear) %>%
  mutate(TESS1  = case_when(TESS1 %in% "Fuel supply" ~ "Other",
                              TESS1 == "LULUCF" ~ "Land Use",
                              TESS1 == "Waste" ~ "Waste Mgmt", TRUE ~ TESS1))%>%
  group_by(TESS1) %>%
  summarise(CO2_total = sum(`Emission`)) %>%
  left_join(sectorColours) %>%
  mutate(percentage = paste0(round(CO2_total / sum(CO2_total) * 100), "%"),
         CO2_total = round(CO2_total),
         colour = case_when(TESS1 == "Land Use" ~ sectorColours$colour[sectorColours$TESS1 == "LULUCF"],
                            TESS1 == "Waste Mgmt" ~ sectorColours$colour[sectorColours$TESS1 == "Waste"],
                            TESS1 == "Other" ~ sectorColours$colour[sectorColours$TESS1 == "Fuel supply"],
         TRUE ~ colour))
  

# Create treemap.
plot_ly(hometreemapdf,
         type = "treemap",
         labels = ~TESS1,
         parents = "",
         values = ~CO2_total,
         marker = list(
         colors = ~colour),
         textinfo = "label+percent root", 
         text = ~paste0(TESS1 ,": ", prettyNum(CO2_total, big.mark = ","), " KtCO\u2082e", " (", percentage, ")"),
         hoverinfo = "text") %>%
  layout(
    hoverlabel = list(font = list(size = 30)),
    uniformtext = list(minsize=16, mode='hide'),
    margin = list(l = 0, r = 0, b = 0, t = 0)
  )  %>%
    config(displaylogo = FALSE)

```

column {data-width=400}
-----------------------------------------------------------------------

### **COMPOSITION OF EMISSIONS (NI & UK) `r currentYear`**

```{r}

# dashboard/images
greenCloudReverse <- "images/Green cloud reverse.png"
blueCloudReverse <- "images/Blue cloud reverse.png"
darkBlueCloud <- "images/Dark Blue Cloud.png"
darkBlueCloudReverse <- "images/Dark Blue Cloud reverse.png"
lightBlueCloud <- "images/Light Blue Cloud.png"
lightBlueCloudReverse <- "images/Light Blue Cloud reverse.png"

# Reshape data to obtain values for infographic
# First for NI
comp_NI <- GHG_NI %>%
  # Filter on current year
  filter(EmissionYear == currentYear) %>%
  # Group Pollutants into "Other" and sum
  mutate(Pollutant = case_when(Pollutant %in% c("CO2", "CH4", "N2O") ~ Pollutant,
                   TRUE ~ "Other")) %>%
  group_by(Pollutant) %>%
  summarise(`Emission` = sum(`Emission`)) %>%
  # Calculate percentage
  mutate(pct = paste0(round(`Emission` / sum(`Emission`) * 100), "%"))

# Repeat above for all regions
comp_All <- GHG_ALL %>%
  # Filter on current year
  filter(EmissionYear == currentYear) %>%
  # Group Pollutants into "Other" and sum
  mutate(Pollutant = case_when(Pollutant %in% c("CO2", "CH4", "N2O") ~ Pollutant,
                   TRUE ~ "Other")) %>%
  group_by(Pollutant) %>%
  summarise(`Emission` = sum(`Emission`)) %>%
  # Calculate percentage
  mutate(pct = paste0(round(`Emission`/sum(`Emission`) * 100), "%"))

# Obtain total figures for bottom of infographic
# NI figure available from cloud and arrow infographic 
co2EquivNI <- co2Compare$`Emission`[co2Compare$EmissionYear == currentYear]
# UK figure available by summing column from comp_All data frame above
co2EquivAll <- round(sum(comp_All$`Emission`) / 1000, 1)

# Colour code
lightBlue <- "#36a9e1"

# Start with an empty ggplot object
ggplot() +
  # Use blank theme theme_void()
  theme_void() +
  ## Text labels for middle of chart, formatted and positioned:
  # Carbon Dioxide
  annotate("text", label = "- Carbon Dioxide -",
           x = 0, y = 0, vjust = -11, colour = lightBlue, size = 5) +
  # Methane
  annotate("text", label = "—— Methane ——",
           x = 0, y = 0, vjust = -2, colour = lightBlue, size = 5) +
  # Nitrous Oxide
  annotate("text", label = "—— Nitrous Oxide ——",
           x = 0, y = 0, vjust = 4.5, colour = lightBlue, size = 5) +
  # Fluroinated and
  annotate("text", label = "—— Fluorinated and ——",
           x = 0, y = 0, vjust = 9, colour = lightBlue, size = 5) +
  # other gases
  annotate("text", label = "other gases",
           x = 0, y = 0, vjust = 10, colour = lightBlue, size = 5) +
  ## Text labels at bottom of infographic
  # NI
  annotate("text", label = "NI", 
           x = 0, y = 0, hjust = 9.3, vjust = 12.3, colour = blue, size = 5) +
  # MtCO2e value for NI
  annotate("text", label = bquote("(" * .(co2EquivNI) ~ "MtCO"[2] * "e)"), 
           x = 0, y = 0, hjust = 1.9, vjust = 11, colour = blue, size = 5) +
  # UK
  annotate("text", label = "UK",
           x = 0, y = 0, hjust = -6, vjust = 12.3, colour = blue, size = 5) +
  # MtCO2e value for UK
  annotate("text", label = bquote("(" * .(co2EquivAll) ~ "MtCO"[2] * "e)"), 
           x = 0, y = 0, hjust = -0.8, vjust = 11, colour = blue, size = 5) +
  ## NI values on clouds
  # CO2 value
  annotate("text", label = comp_NI$pct[comp_NI$Pollutant == "CO2"], 
           x = 0, y = 0, hjust = 2.2, vjust = -4.5, colour = "white", size = 12, fontface = "bold") +
  # CH4 value
  annotate("text", label = comp_NI$pct[comp_NI$Pollutant == "CH4"],
           x = 0, y = 0, hjust = 2.2, vjust = -0.6, colour = "white", size = 12, fontface = "bold") +
  # N2O value
  annotate("text", label = comp_NI$pct[comp_NI$Pollutant == "N2O"],
           x = 0, y = 0, hjust = 3, vjust = 2.2, colour = "white", size = 12, fontface = "bold") +
  # Others value
  annotate("text", label = comp_NI$pct[comp_NI$Pollutant == "Other"], 
           x = 0, y = 0, hjust = 3.3, vjust = 4.5, colour = "white", size = 11, fontface = "bold") +
  ## UK values on clouds
  # CO2 value
  annotate("text", label = comp_All$pct[comp_All$Pollutant == "CO2"],
            x = 0, y = 0, hjust = -1.4, vjust = -4.5, colour = "white", size = 12, fontface = "bold") +
  # CH4 value
  annotate("text", label = comp_All$pct[comp_All$Pollutant == "CH4"], 
           x = 0, y = 0, hjust = -1.4, vjust = -0.6, colour = "white", size = 12, fontface = "bold") +
  # N2O value
  annotate("text", label = comp_All$pct[comp_All$Pollutant == "N2O"], 
           x = 0, y = 0, hjust = -2, vjust = 2.2, colour = "white", size = 12, fontface = "bold") +
  # Others value
  annotate("text", label = comp_All$pct[comp_All$Pollutant == "Other"], 
           x = 0, y = 0, hjust = -2.4, vjust = 4.5, colour = "white", size = 11, fontface = "bold") +
  # dashboard/images inserted and positioned
  inset_element(p = readPNG(blueCloud, native = TRUE),
                left = 0.05, bottom = 0.72, right = 0.35, top = 1, on_top = FALSE) +
  inset_element(p = readPNG(greenCloud, native = TRUE),
                left = 0.07, bottom = 0.45, right = 0.33, top = 0.72, on_top = FALSE) +
  inset_element(p = readPNG(darkBlueCloud, native = TRUE),
                left = 0.09, bottom = 0.29, right = 0.31, top = 0.45, on_top = FALSE) +
  inset_element(p = readPNG(lightBlueCloud, native = TRUE),
                left = 0.11, bottom = 0.15, right = 0.29, top = 0.29, on_top = FALSE) +
  inset_element(p = readPNG(blueCloudReverse, native = TRUE),
                left = 0.65, bottom = 0.72, right = 0.95, top = 1, on_top = FALSE) +
  inset_element(p = readPNG(greenCloudReverse, native = TRUE),
                left = 0.67, bottom = 0.45, right = 0.93, top = 0.72, on_top = FALSE) +
  inset_element(p = readPNG(darkBlueCloudReverse, native = TRUE),
                left = 0.69, bottom = 0.29, right = 0.91, top = 0.45, on_top = FALSE) +
  inset_element(p = readPNG(lightBlueCloudReverse, native = TRUE),
                left = 0.71, bottom = 0.15, right = 0.89, top = 0.29, on_top = FALSE)


```


### **CHANGE IN EMISSIONS BY SECTOR FROM BASE YEAR-`r currentYear` (KtCO<sub>2</sub>e)**

```{r, echo = FALSE}
sectortotdf <- GHG_NI %>%
  filter(EmissionYear == currentYear) %>%
  group_by(TESS1) %>%
  summarise(CO2 = sum(`Emission`))%>%
  mutate(sectorLabel = paste0(TESS1, ": ", prettyNum(round(CO2), big.mark = ","), " KtCO2e"),
         CO2 = round(CO2, 2))

sectorChange <- GHG_NI %>%
  filter(EmissionYear %in% c(1989, currentYear)) %>%
   mutate(TESS1  = case_when(TESS1  == "Land use, land use change and forestry" ~ "Land Use",
                              TRUE ~ TESS1))%>%
  group_by(`<b>Sector</b>` = TESS1, EmissionYear) %>%
  filter(TESS1 != "Fuel supply") %>% # Filter fuel supply from chart
  summarise(co2Total = sum(`Emission`)) %>%
  ungroup() %>%
  pivot_wider(id_cols = `<b>Sector</b>`,
              names_from = EmissionYear,
              names_glue = "<b>{EmissionYear}</b>",
              values_from = co2Total,
              values_fn = function(x) {prettyNum(round(x), big.mark = ",")}) %>%
  mutate(`<b>Change</b>` = round(((as.numeric(sub(",","",.[[3]])) - as.numeric(sub(",","",.[[2]]))) / as.numeric(sub(",","",.[[2]])) * 100)),
         textColour = case_when(`<b>Change</b>` > 0 ~ "red",
                               `<b>Change</b>` < 0 ~ "green",
                               TRUE ~ "black"),
         ` ` = case_when(`<b>Change</b>` > 0 ~ "\u2B06",
                               `<b>Change</b>` < 0 ~ "\u2B07",
                               TRUE ~ ""),
         `<b>Change</b>` = case_when(`<b>Change</b>` > 0 ~ paste0("<b>+", `<b>Change</b>`, "%</b>"),
                                           TRUE ~ paste0("<b>", `<b>Change</b>`, "%</b>")))

colnames(sectorChange)[2]  <- "<b>Base Year<b>"


table <- plot_ly(
  type = "table",
  header = list(
    values = names(sectorChange)[c(1:4, 6)],
    align = c('left', rep('right', 3), "left"),
    line = list(width = 0),
    font = list(family = "Arial", size = 18)
  ),
  cells = list(
    values =
      t(as.matrix(unname(sectorChange[c(1:4, 6)]))),
    align = c('left', rep('right', 3), "left"),
    line = list(width = 0),
    font = list(family = "Arial", size = c(rep(18, 4), 32), color = c(rep("black", 3), list(sectorChange$textColour)))
  ),
  columnwidth = c(8, 4, 4, 4, 1)
  )  %>%
  layout(annotations = list(
    list(text = "<b>Total CO<sub>2</sub>e Emissions</b>", 
         showarrow = FALSE, 
         x = 0.6, xref = "paper", 
         xanchor = "center", 
         y = 1.07, yref = "paper", 
         yanchor = "top", 
         font=list(color = "#444444", size = 16))))%>%
    config(displaylogo = FALSE)


table



```

Northern Ireland {data-navmenu="SECTOR EMISSIONS"}
=======================================================================


column {.tabset}
---------------------------------

### Graph


```{r Northern ireland graph}

sectordata1 <- GHG_ALL %>%
  select(-c(SourceName, IPCC_code, TESS2, Mt)) %>%
  group_by(EmissionYear, Pollutant, RegionName, TESS1) %>%
  summarise(Emission = sum(Emission))

sectordata2 <- GHG_ALL %>%
  group_by(EmissionYear, RegionName, TESS1) %>%
  summarise(Emission = sum(Emission))

sectordata2$Pollutant <- "(All Aggregated)"

sectordata3 <- GHG_ALL %>%
  group_by(EmissionYear, RegionName) %>%
  summarise(Emission = sum(Emission))

sectordata3$Pollutant <- "(All Aggregated)"
sectordata3$NCFormat <- "(All Aggregated)"

sectordata4 <- full_join(sectordata1, sectordata2)
sectordata4 <- full_join(sectordata4, sectordata3)%>%
  filter(RegionName != "Unallocated") %>%
  mutate(Emission = round(Emission, digits = 2),
         pre1997 = ifelse(EmissionYear > 1989 & EmissionYear < 1997, Emission, NA),
         post1997 = ifelse(EmissionYear > 1997 & EmissionYear <= currentYear, Emission, NA),
         label = ifelse(EmissionYear == 1989, TESS1, NA),
         eYear = factor(EmissionYear,
                        levels = 1989:currentYear,
                        labels = c("Base year", 1990:currentYear)),
         CO2comma = prettyNum(Emission, big.mark = ","),
         EmissionYear = as.Date(paste0(EmissionYear, "-01-01"))) %>%
  select(eYear, Pollutant, RegionName, TESS1, CO2comma, pre1997, post1997, EmissionYear, Emission) %>%
  group_by(Pollutant, RegionName, TESS1)

eYear2Labels <- c()
for (i in 2:length(levels(sectordata4$eYear))) {
  eYear2Labels[i] <- if (levels(sectordata4$eYear)[i] %in% levels(sectordata4$eYear)[as.numeric(levels(sectordata4$eYear)) %% 10 == 0]) {
    levels(sectordata4$eYear)[i]
  } else {
    paste0("'", substr(levels(sectordata4$eYear)[i], 3, 4))
  }
}

eYear2 <- factor(sectordata4$eYear,
                 levels = levels(sectordata4$eYear),
                 labels = eYear2Labels)

Shared_sectordata4 <- SharedData$new(sectordata4)
sectordata4$Pollutant <- "(All Aggregated)"


lineText = paste("\nSector:", sectordata4$TESS1, "\nRegion:", sectordata4$RegionName, "\nEmission:", sectordata4$Emission)

yaxistitle <- list(x = 0, y = 1, text = "Kilotonnes\nCO\u2082e", 
                   showarrow = F, xref= "paper", yref="paper", 
                   xanchor = "center", yanchor="bottom",
                   font = list(size = 12))

figSectors <- Shared_sectordata4 %>%
  plot_ly(x = ~eYear2,
  y = ~post1997,
  color = ~TESS1,
  type = "scatter",
  mode = "lines+markers",
  colors = sectorColours$colour,
  text = lineText,
  hoverinfo = "text",  # Add this line to show only the text on hover
  showlegend = FALSE) %>%
  add_trace(y = ~pre1997,
            mode = "markers") %>%
  layout(xaxis = list(title = "",
                      tickangle = 0,
                      zeroline = FALSE),
         yaxis = list(title = "",
                      tickformat = ",d",
                      showline = TRUE),
         annotations = list(yaxistitle),
         margin = list(t = 50),
#         hovermode = "x unified",
         title = "Sectoral emissions in Northern Ireland and other regions",
         title = list(font = 25),
         clickmode = "none") %>%
  config(displaylogo = FALSE)

figSectors
```

### Table

```{r}

tableSectors <- datatable(Shared_sectordata4,
                          colnames = c("Year", "Pollutant", "Region", "Sector", "CO\u2082 Equivalents (kilotonnes CO\u2082e)"),
                          fillContainer = FALSE,
                          rownames = FALSE,
                          extensions = 'Buttons', options = list(
                            columnDefs = list(list(visible = FALSE, targets = 5:8),
                                              list(className = "dt-body-right", targets = c(0,4)),
                                              list(className = "dt-right", targets = c(0,4)),
                                              list(className = 'dt-left', targets = "_all")),
                            pageLength = 15,
                            lengthMenu = c(5, 10, 15, 20),
                            dom = 'Bfrtip',
                            buttons = list(
                              list(extend = "pdf", exportOptions = list(columns = ":visible")),
                              list(extend = "excel", exportOptions = list(columns = ":visible")),
                              list(extend = "csv", exportOptions = list(columns = ":visible")),
                              list(extend = "copy", exportOptions = list(columns = ":visible")),
                              list(extend = "print", exportOptions = list(columns = ":visible"))
                            )
                          ))

tableSectors

```

```{r, echo  = FALSE}
filtersNI <- bscols(
  list(""),
  list("Click inside boxes to add other lines, by region, pollutant, or sector. (All) represents the total of all gas types added together. Click below to add other gas types to the line graph and delete (All Aggregated) to remove it from the line graph",
       filter_select(id = "POLLUTANT", label = "Pollutant",sharedData = Shared_sectordata4, group = ~Pollutant, selected = "(All Aggregated)"),
       "To focus on a particular RegionName, click and delete to remove from the line graph",
       filter_select(id = "RegionName ", label = "Region", sharedData = Shared_sectordata4, group = ~RegionName, selected = "Northern Ireland" ),
       "To focus on a particular TESS1, click and delete to remove from the line graph",
       filter_select(id = "TESS1", label = "TESS1", sharedData = Shared_sectordata4, group = ~TESS1, selected = c("Agriculture", "Buildings and product uses", "Domestic transport", "Electricity supply", "Fuel supply", "Industry", "LULUCF", "Waste")),
      # filter_select(id = "TESS2", label = "TESS2", sharedData = Shared_sectordata4, group = ~TESS2),
       filter_slider(id = "EmissionYear", label = "Year", sharedData = Shared_sectordata4, column = ~EmissionYear, timeFormat = "%Y")
  ),
  list(""),
  widths = c(1, NA, 1)
)
filtersNI
```


```{r, echo  = FALSE}



#Function to code for sector graphs, tables and filters
sectorEmission <- function(sector) {
  
   data1 <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    select(-c(RegionName, TESS1, Mt))
  
  data2 <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2) %>%
    summarise (Emission = round(sum(Emission), 2), .groups = 'drop') %>%
    mutate (Pollutant = "(All Aggregated)",
           IPCC_code = "(All Aggregated)",
           TESS3 = "(All Aggregated)")
  
  data3a <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2,TESS3, Pollutant) %>%
    summarise(Emission = sum(Emission), .groups = 'drop') %>%
    mutate(IPCC_code = "(All Aggregated)")
  
  data3b <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2,TESS3, IPCC_code) %>%
    summarise(Emission = sum(Emission), .groups = 'drop') %>%
    mutate(Pollutant = "(All Aggregated)")
  
  data3c <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2, IPCC_code, Pollutant) %>%
    summarise(Emission = sum(Emission), .groups = 'drop') %>%
    mutate(TESS3 = "(All Aggregated)"
           )
  
  data3d <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2, IPCC_code) %>%
    summarise(Emission = sum(Emission), .groups = 'drop') %>%
    mutate(TESS3 = "(All Aggregated)", 
           Pollutant = "(All Aggregated)")
  
  data3e <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2, Pollutant) %>%
    summarise(Emission = sum(Emission), .groups = 'drop') %>%
    mutate(TESS3 = "(All Aggregated)", 
           IPCC_code = "(All Aggregated)")
  
  data3f <- GHG_NI %>%
    filter(TESS1 == sector) %>%
    group_by(EmissionYear, TESS2,TESS3) %>%
    summarise(Emission = sum(Emission), .groups = 'drop') %>%
    mutate(Pollutant = "(All Aggregated)", 
           IPCC_code = "(All Aggregated)")
  
   data4 <- full_join(data1, data2)
  
  data4 <- full_join(data4, data3a)
  
  data4 <- full_join(data4, data3b)
  
  data4 <- full_join(data4, data3c)
  
  data4 <- full_join(data4, data3d)
  
  data4 <- full_join(data4, data3e)
  
  data4 <- full_join(data4, data3f) %>%
    mutate(Emission = round(Emission, digits = 2),
           pre1997 = ifelse(EmissionYear > 1989 & EmissionYear < 1997, Emission, NA),
           post1997 = ifelse(EmissionYear > 1997, Emission, NA),
           eYear = factor(
             EmissionYear, 
             levels = 1989:currentYear, 
             labels = c("Base year", 1990:currentYear)),
           CO2comma = prettyNum(Emission, big.mark = ","),
           EmissionYear = as.Date(paste0(EmissionYear, "-01-01"))
) %>%
    select(eYear, Pollutant, TESS2,TESS3, IPCC_code, CO2comma, pre1997, post1997, EmissionYear, Emission) %>%
    group_by(Pollutant, 
             IPCC_code, 
             TESS2,
             TESS3)
 
  eYear2Labels <- c()
  for (i in 2:length(levels(data4$eYear))) {
    eYear2Labels[i] <- if (levels(data4$eYear)[i] %in% levels(data4$eYear)[as.numeric(levels(data4$eYear)) %% 10 == 0]) {
      levels(data4$eYear)[i]
    } else {
      paste0("'", substr(levels(data4$eYear)[i], 3, 4))
    }
  }
  
  eYear2 <- factor(data4$eYear, 
                   levels = levels(data4$eYear), 
                   labels = eYear2Labels)
  
  Shared_data4 <- SharedData$new(data4)
  
  lineText = paste("Sub-Sector:", data4$TESS2, "<br>Pollutant:", data4$Pollutant, "<br>IPCC_code:", data4$IPCC_code, "<br>Pollutant Source:", data4$TESS3, "<br>Emission:", data4$Emission)
  
  yaxistitle <- list(x = 0, y = 1, text = "CO2 Equivalents\n(Kilotonnes CO\u2082e)", 
                     showarrow = F, xref = "paper", yref = "paper", 
                     xanchor = "center", yanchor = "bottom",
                     font = list(size = 12))
  
fig <<- 
  plot_ly(Shared_data4, 
          x = eYear2, 
          y = ~post1997, 
          color = ~TESS2,  # Display TESS2 values only
          type = "scatter", 
          mode = "lines+markers",
          text = lineText, 
                hoverinfo = 'text', 
          showlegend = FALSE) %>%
    add_trace(y = ~pre1997, 
              mode = 'markers') %>%
    layout(xaxis = list(title = "",
                        tickangle = 0,
                        zeroline = FALSE),
           yaxis = list(title = "",
                        tickformat = ".2f",
                        showline = TRUE),
           annotations = list(yaxistitle),
           margin = list(t = 50),
           
           title = paste("Emissions in Northern Ireland", sector, "sector"),
           titlefont = list(size = 25),
           clickmode = "none") %>%
    config(displaylogo = FALSE)
  

 
  sectTable <<- datatable(Shared_data4,
                          colnames = c("Year", "Pollutant", "Sub-sector", "Pollutant Source", "IPCC_code", "Kilotonnes CO\u2082e", "CO2 Equivalents (pre-1997) (kilotonnes CO2 e)", "CO2 Equivalents (post-1997) (kilotonnes CO2 e)", "[Emission Year]", "CO2 Equivalents. (kilotonnes CO2 e)"),
                          fillContainer = FALSE,
                          rownames = FALSE,
                          extensions = 'Buttons',
                          options = list(
                            columnDefs = list(
                              list(visible = FALSE, targets = 6:9),
                              list(className = "dt-body-right", targets = c(0, 5)),
                              list(className = "dt-right", targets = c(0, 5)),
                              list(className = "dt-left", targets = "_all")),
                            pageLength = 15,
                            lengthMenu = c(5, 10, 15, 20),
                            dom = 'Bfrtip',
                            buttons = list(
                              list(extend = "pdf", exportOptions = list(columns = ":visible")),
                              list(extend = "excel", exportOptions = list(columns = ":visible")),
                              list(extend = "csv", exportOptions = list(columns = ":visible")),
                              list(extend = "copy", exportOptions = list(columns = ":visible")),
                              list(extend = "print", exportOptions = list(columns = ":visible"))
                            )
                          ))
  
# Define the filters
filters <<- bscols(
    list(""),
    list("Click inside boxes to add other lines, by region, pollutant, or sector. (All) represents the total of all gas types added together. Click below to add other gas types to the line graph and delete (All Aggregated) to remove it from the line graph",
         filter_select(id = "POLLUTANT", label = "Pollutant",sharedData = Shared_data4, group = ~Pollutant, selected = "(All Aggregated)"),
        "To focus on a particular TESS2, click and delete to remove from the line graph",
         filter_select(id = "TESS2", label = "TESS2", sharedData = Shared_data4, group = ~TESS2, selected = "(All Aggregated)"),
        "To focus on a particular TESS3, click and delete to remove from the line graph",
         filter_select(id = "TESS3", label = "TESS3", sharedData = Shared_data4, group = ~TESS3, selected = "(All Aggregated)"),  # New filter for TESS3
        "To focus on a particular IPCC code, click and delete to remove from the line graph",
        filter_select(id = "IPCC_code", label = "IPCC", sharedData = Shared_data4, group = ~IPCC_code, selected = "(All Aggregated)"),
      #  filter_select(id = "SourceName", label = "Pollutant Source", sharedData = Shared_data4, group = ~SourceName),
        filter_slider(id = "EmissionYear", label = "Year", sharedData = Shared_data4, column = ~EmissionYear, timeFormat = "%Y")
    ),
    list(""),
    widths = c(1, NA, 1)
)
  
}

```

Column {.sidebar}
----------------

### Filters

```{r}
filtersNI
```


Agriculture {data-navmenu="SECTOR EMISSIONS"}
========================================

column {.tabset}
---------------------------------

### Graph

```{r}

sectorEmission(sector = "Agriculture")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```


Buildings and product uses {data-navmenu="SECTOR EMISSIONS"}
========================================

column {.tabset}
---------------------------------

### Graph

```{r}

sectorEmission(sector = "Buildings and product uses")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```


Domestic transport {data-navmenu="SECTOR EMISSIONS"}
====================================================

column {.tabset}
---------------------------------

### Graph

```{r}

sectorEmission(sector = "Domestic transport")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```

Electricity supply  {data-navmenu="SECTOR EMISSIONS"}
====================================================

column {.tabset}
---------------------------------

### Graph

```{r}
sectorEmission(sector = "Electricity supply")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```

Fuel supply {data-navmenu="SECTOR EMISSIONS"}
====================================================

column {.tabset}
---------------------------------

### Graph



```{r}
sectorEmission(sector = "Fuel supply")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```

Industry  {data-navmenu="SECTOR EMISSIONS"}
====================================================

column {.tabset}
---------------------------------

### Graph

```{r}
sectorEmission(sector = "Industry")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```

LULUCF  {data-navmenu="SECTOR EMISSIONS"}
====================================================

column {.tabset}
---------------------------------

### Graph

```{r}
sectorEmission(sector = "LULUCF")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```

Waste  {data-navmenu="SECTOR EMISSIONS"}
====================================================

column {.tabset}
---------------------------------

### Graph

```{r}
sectorEmission(sector = "Waste")

fig

```


### Table

```{r}
sectTable
```

Column {.sidebar}
----------------

### Filters

```{r}
filters
```



COMPARISONS {data-icon="ion-stats-bars"}
=======================================================================

Column {.tabset}
-----------------------------------------------------------------------
### **Total NI CO<sub>2</sub>e Emissions by Sector `r currentYear`**
```{r}
#Create 2019 Bar Chart for all sectors.
homebardf <- GHG_NI %>%
  filter(EmissionYear == currentYear) %>%
  group_by(TESS1 ) %>%
  summarise(Emission = round(sum(`Emission`), 0)) %>%
  left_join(sectorColours) %>%
  mutate(TESS1  = wrap.labels(TESS1 , 12))

yaxistitle <- list(x = 0, y = 1, text = "Kilotonnes\nCO\u2082e", 
                showarrow = F, xref= "paper", yref="paper", 
                xanchor = "center", yanchor="bottom",
                font = list(size = 14))

plot_ly(data = homebardf,
        x = ~TESS1 ,
        y = ~Emission,
        type = "bar",
        marker = list(color = ~colour)) %>%
  layout(title = paste0(currentYear, " Northern Ireland CO\u2082e emissions by sector"),
         titlefont = list(size = 25),
         xaxis = list(title = "Sector",
                      tickangle = 0),
         yaxis = list(title = "",
                      tickformat = ",d",
                      showline = TRUE),
         annotations = list(yaxistitle),
         margin = list(t = 50))  %>%
    config(displaylogo = FALSE)
```

### **Total NI CO<sub>2</sub>e Emissions by Year and Sector**
```{r}


stackedBarData <- GHG_NI %>%
  group_by(Sector = TESS1 , eYear = EmissionYear) %>%
  summarise(Total_CO2e = round(sum(`Emission`))) %>%
  mutate(Sector = wrap.labels(Sector, 25),
         eYear = factor(eYear,
                       levels = 1989:max(eYear),
                       labels = c("Base\nyear", 1990:max(eYear)))) %>%
  pivot_wider(id_cols = eYear, names_from = Sector, values_from = Total_CO2e)


# Declare list of sectors and colours
sectors <- rev(unique(names(stackedBarData[names(stackedBarData) != "eYear"])))
colours <- rev(sectorColours$colour)

# Create first bar
stackedBar <- plot_ly(stackedBarData,
                      x = ~eYear,
                      y = stackedBarData[[sectors[1]]],
                      type = "bar", marker = list(color = colours[1]),
                      name = sectors[1])  %>%
    config(displaylogo = FALSE)

# Loop to create others with add_trace()
for (i in 2:length(sectors)) {
  stackedBar <- stackedBar %>%
  add_trace(
    y = stackedBarData[[sectors[i]]],
    marker = list(color = colours[i]),
    name = sectors[i])
}

yaxistitle <- list(x = 0, y = 1, text = "Total\nKilotonnes\nCO\u2082e", 
                   showarrow = F, xref = "paper", yref = "paper", 
                   xanchor = "center", yanchor = "bottom",
                   font = list(size = 14))

stackedBar %>%
  layout(barmode = "stack",
         title = "Total Northern Ireland CO\u2082e emissions by year and sector",
         titlefont = list(size = 25),
         xaxis = list(title = "Emission year",
                      tickangle = 0),
         yaxis = list(title = "",
                      tickformat = ",d",
                      showline = TRUE),
         annotations = list(yaxistitle),
         hovermode = "x unified",
         margin = list(t = 75))
  

```


### **UK Historic Comparison (Bar Chart Race)**

```{r Countries bar race}



sectorSumAll <- GHG_ALL %>%
  filter(RegionName != "Unallocated") %>%
  group_by(EmissionYear, RegionName) %>%
  summarise(sumCO2 = sum(`Emission`)) %>%
  mutate(Year = factor(EmissionYear,
                       levels = years,
                       labels = c("Base year", years[2:length(years)]))) %>%
  pivot_wider(id_cols = Year, names_from = RegionName, values_from = sumCO2)

regionBarRace <- sectorSumAll %>%
  plot_ly(x = ~England,
          y = "England",
          hoverinfo = "x",
          text = "England",
          textposition = "outside",
          type = "bar",
          frame = ~Year,
          marker = list(color = "#197e84"),
          showlegend = FALSE) %>%
  add_trace(x = ~Scotland,
            y = "Scotland",
            text = "Scotland",
            marker = list(color = "#831d5c")) %>%
  add_trace(x = ~Wales,
            y = "Wales",
            text = "Wales",
            marker = list(color = "#7e749d")) %>%
  add_trace(x = ~`Northern Ireland`,
            y = "Northern Ireland",
            text = "Northern Ireland",
            marker = list(color = "#819dcb")) %>%
  layout(
    xaxis = list(
      title = "Greenhouse gas emissions MtCO\u2082e (log base 10 scale)",
      type = "log"
    ),
    yaxis = list(
      title = "",
      categoryorder = "sum ascending",
      showticklabels = FALSE
    )
  )  %>%
    config(displaylogo = FALSE) %>%
  animation_slider(
currentvalue = list(prefix = "Year: ", font = list(color="black", size = 20))
)

regionBarRace

```

### **NI Historic Sector Comparison (Bar Chart Race)**

```{r Bar chart race by sector}
#Aggregate by year and sector
# sectorSumNI <- GHG_NI %>%
#   group_by(EmissionYear, TESS1 ) %>%
#   summarise(sumCO2 = sum(`Emission`)) %>%
#   mutate(EmissionYear = factor(EmissionYear,
#                        levels = years,
#                        labels = c("Base year", years[2:length(years)]))) %>%
#   arrange(sumCO2) %>%
#   left_join(sectorColours)
# 
# #Sector bar chart race
# sectorBarChartRace <- sectorSumNI %>%
#   plot_ly(x=~sumCO2, y=~TESS1 ) %>%
#   add_bars(frame = ~ EmissionYear, ids = ~TESS1 , showlegend = FALSE,
#            text = ~TESS1 , textposition = 'outside') %>%
#   layout(xaxis = list(title="Greenhouse gas emissions MtCO\u2082e"),
#     yaxis = list(title = "", categoryorder = "array", categoryarray = ~sumCO2, showticklabels = FALSE))
# 
# sectorBarChartRace

sectorSumNI <- GHG_NI %>%
  group_by(Year = EmissionYear, TESS1 ) %>%
  summarise(sumCO2 = sum(`Emission`)) %>%
  mutate(Sector = wrap.labels(TESS1 , 25),
         Year = factor(Year,
                       levels = years,
                       labels = c("Base year", years[2:length(years)]))) %>%
  pivot_wider(id_cols = Year, names_from = Sector, values_from = sumCO2)

sectors <- unique(names(sectorSumNI[names(sectorSumNI) != "Year"]))
colours <- sectorColours$colour

sectorBarChartRace <- sectorSumNI %>%
  plot_ly(x = ~.[[sectors[1]]],
          y = sectors[1],
          hoverinfo = "x",
          text = sectors[1],
          textposition = "outside",
          type = "bar",
          frame = ~Year,
          marker = list(color = colours[1]),
          showlegend = FALSE)  %>%
    config(displaylogo = FALSE)

for (i in 2:length(sectors)) {
  sectorBarChartRace <- sectorBarChartRace %>%
    add_trace(x = sectorSumNI[[sectors[i]]],
          y = sectors[i],
          text = sectors[i],
          marker = list(color = colours[i]))
}


sectorBarChartRace <- sectorBarChartRace %>%
  layout(
    xaxis = list(
      title = "Greenhouse gas emissions MtCO\u2082e",
      tickformat = ",d"
    ),
    yaxis = list(
      title = "",
      categoryorder = "sum ascending",
      showticklabels = FALSE
    )) %>%
  animation_slider(
    currentvalue = list(prefix = "Year: ", font = list(color="black", size = 20))
  )

sectorBarChartRace

```

EXPLORE {data-icon="ion-grid"}
=======================================================================
Column {.tabset}
-----------------------------------------------------------------------
### **Rankings Table (`r currentYear`)**

```{r}
#CREATING RANKING TABLE WITH FILTER

GHG_NI_thisYr <- GHG_NI %>%
  filter(EmissionYear == currentYear) %>%
  group_by(Sector = TESS1 , `Pollutant Source` = SourceName) %>%
  summarise(CO2 = round(sum(`Emission`), 2)) %>%
  arrange(desc(CO2)) %>%
  mutate(CO2 = format(CO2, big.mark = ","))

names(GHG_NI_thisYr)[names(GHG_NI_thisYr) == "CO2"] <- "Total Emissions (KtCO\u2082e)"

sharedGHG_NI_thisYr <- SharedData$new(GHG_NI_thisYr, key =~Sector)

filter_select(id = "TESS1", label = "Select Sectors", sharedData = sharedGHG_NI_thisYr, group = ~Sector)

h2(paste0("NI Greenhouse Gas Emissions Ranking Table ", currentYear))

datatable(sharedGHG_NI_thisYr,
          colnames = c("Rank", "Sector", "Source", "Total Emissions (KtCO\u2082e)" ),
          fillContainer = FALSE,
          extensions = 'Buttons',
          options = list(
            columnDefs = list(
              list(visible = FALSE, targets = FALSE),
              list(className = "dt-right", targets = list(0,3)),
              list(className = "dt-left", targets = 1:2)),
            list(width = "10px", targets = 0),
            dom = 'Bfrtip',
            buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))

```

### **Tree Map (`r currentYear`)**
```{r}
sectorLabels <- sectortotdf %>%
  select(TESS1 , sectorLabel)

alltreemapdf <- GHG_NI %>%
  filter(EmissionYear==currentYear) %>%
  group_by(TESS1, TESS2, TESS3) %>%
  summarise(Emission = sum(`Emission`)) %>%
  left_join(sectorLabels, by = "TESS1")


formatLabels <- alltreemapdf %>%
  group_by(TESS2, TESS3, TESS1) %>%
  summarise(count = n()) %>%
  mutate(subsector = case_when(
      TESS2 == lag(TESS3) ~ paste0(TESS2, " (",TESS1, ")"),
      TESS2 == lead(TESS3) ~ paste0(TESS2, " (", TESS1, ")"),
      TRUE ~ TESS2
    )) %>%
  select(-count)

alltreemapdf <- left_join(alltreemapdf, formatLabels, by = c("TESS1", "TESS2", "TESS3")) %>%
  mutate(subsector = wrap.labels(subsector, 15))


tmap_labels <- c("2022 Sector Emissions", unique(alltreemapdf$sectorLabel), alltreemapdf$TESS3) # Update the labels vector
tmap_parents <- c("", rep("2022 Sector Emissions", length(unique(alltreemapdf$TESS1))), alltreemapdf$sectorLabel)  # Update the parents vector
tmap_values <- c(rep(0, length(unique(alltreemapdf$TESS1)) + 1), round(alltreemapdf$Emission, 0))

alltreemap <- plot_ly(
  type="treemap",
  labels=tmap_labels,
  parents=tmap_parents,
  values= tmap_values,
  marker=list(colors= c("white",sectorColours$colour)),
  textinfo = "label",
  text = paste0(tmap_labels,": ", prettyNum(tmap_values, big.mark = ",")," KtCO\u2082e"),
  hoverinfo = 'text'
)%>%
  layout(
    hoverlabel = list(font=list(size=30))
  )

h3(span(style = "font-size: 16pt;",span(style = "font-weight: bold;", "Interactive Tree Map:"), "Click on any sector name ( e.g. Agriculture, Business etc) to have a closer look at the sub-sectors within that sector. Click the sector name again to return to the full tree map."))

alltreemap

```

### **Projections**
```{r}

projection <- PROJ_ACTUAL_NI %>%
  group_by(EmissionYear, NCFormat) %>%
  summarise(`Emission` = sum(`Emission`))

projection$Source <- "Actual"


projection2 <- GHG_PROJ %>%
  filter(Year > currentYear) %>%
  select(-c(GHG, Emissions)) %>%
  na.omit()

projection2$Source <- "Projection"
names(projection2)[names(projection2) == "Year"] <- "EmissionYear"
names(projection2)[names(projection2) == "Sector"] <- "NCFormat"
names(projection2)[names(projection2) == "Projections"] <- "Emission"

lastProj <- max(projection2$EmissionYear)

projection2$`Emission`<-as.numeric(projection2$`Emission`)

projectionFull <- full_join(projection, projection2)  %>%
  mutate(`Emission` = round(`Emission`, digits = 2),
         pre1997 = ifelse(EmissionYear < 1997, `Emission`, NA),
         post1997 = ifelse(EmissionYear > 1997 & EmissionYear <= currentYear, `Emission`, NA),
         projection = ifelse(EmissionYear > 2021, `Emission`, NA),
         label = ifelse(EmissionYear == 1989, NCFormat, NA),
         eYear = factor(EmissionYear,
                        levels = 1989:lastProj,
                        labels = c("Base year", 1990:lastProj)),
         CO2comma = prettyNum(`Emission`, big.mark = ","),
         EmissionYear = as.Date(paste0(EmissionYear, "-01-01"))) %>%
  select(eYear, NCFormat, Source, CO2comma, pre1997, post1997, EmissionYear, `Emission`, projection) %>%
  group_by(NCFormat)

eYear2Labels <- c()
for (i in 1:length(levels(projectionFull$eYear))) {
  eYear2Labels[i] <- if (levels(projectionFull$eYear)[i] == "Base year") {
    "Base\nyear"
  } else if (levels(projectionFull$eYear)[i] %in% levels(projectionFull$eYear)[as.numeric(levels(projectionFull$eYear)) %% 10 == 0]) {
    levels(projectionFull$eYear)[i]
  } else {
    paste0("'", substr(levels(projectionFull$eYear)[i], 3, 4))
  }
}

eYear2 <- factor(projectionFull$eYear,
                 levels = levels(projectionFull$eYear),
                 labels = eYear2Labels)

Shared_projection <- SharedData$new(projectionFull)

lineTextProj = paste("\nSector:", projectionFull$NCFormat)

yaxistitle <- list(x = 0, y = 1, text = "Kilotonnes\nCO\u2082e", 
                   showarrow = F, xref= "paper", yref="paper", 
                   xanchor = "center", yanchor="bottom",
                   font = list(size = 12))

figProjections <- Shared_projection %>%
  plot_ly(x = ~eYear2,
  y = ~post1997,
  color = ~NCFormat,
  type = "scatter",
  mode = "lines+markers",
  colors = sectorColours$colour,
  text = lineTextProj,
  showlegend = FALSE) %>%
  add_trace(y = ~pre1997,
            mode = "markers") %>%
  add_trace(y = ~projection,
            line = list(dash = "dash")) %>%
  layout(xaxis = list(title = "",
                      tickangle = 0,
                      zeroline = FALSE),
         yaxis = list(title = "",
                      tickformat = ",d",
                      showline = TRUE),
         annotations = list(yaxistitle),
         margin = list(t = 50),
#         hovermode = "x unified",
         title = "Projected sectoral emissions in Northern Ireland", titlefont = list(size = 25),
         clickmode = "none") %>%
  config(displaylogo = FALSE)


tableProjections <- datatable(Shared_projection,
                          colnames = c("Year", "Sector", "Actual or Projected", "CO\u2082 Equivalents (kilotonnes CO\u2082e)"),
                          fillContainer = FALSE,
                          rownames = FALSE,
                          extensions = 'Buttons', options = list(
                            columnDefs = list(list(visible = FALSE, targets = 4:8),
                                              list(className = "dt-body-right", targets = c(0,3)),
                                              list(className = "dt-right", targets = c(0,3)),
                                              list(className = 'dt-left', targets = "_all")),
                            dom = 'Bfrtip',
                            buttons = list(
                              list(extend = "pdf", exportOptions = list(columns = ":visible")),
                              list(extend = "excel", exportOptions = list(columns = ":visible")),
                              list(extend = "csv", exportOptions = list(columns = ":visible")),
                              list(extend = "copy", exportOptions = list(columns = ":visible")),
                              list(extend = "print", exportOptions = list(columns = ":visible"))
                            )
                              ))



div(class = "row", style = "display: flex;",
    div(style = "width: 2%"),
    div(style = "width: 76%",
        div(style = "height: 45%", figProjections),
        div(style = "height: 50%", tableProjections),
        div(style = "height: 5%")),
    div(style = "width: 2%"),
    div(style = "width: 18%",
         filter_select(id = "NCFormat", label = "Sector", sharedData = Shared_projection, group = ~NCFormat),
         filter_slider(id = "EmissionYear", label = "Year", sharedData = Shared_projection, column = ~EmissionYear, timeFormat = "%Y"),
         filter_checkbox(id= "Source", label = "Actual/Projection", sharedData = Shared_projection, group=~Source)
        ),
    div(style = "width: 2%")
    )
```






USER NOTES {data-icon="ion-clipboard"}
=======================================================================
Column {.tabset}
-----------------------------------------------------------------------
### **NOTES**


**User Notes**

**Introduction:** This dashboard presents data for Northern Ireland, from the Greenhouse Gas (GHG) Inventory. The GHG inventory provides the official estimates of emissions for the UK and each DA from 1990 to the latest available year. The inventory fulfils the United Nations Framework Convention on Climate Change (UNFCCC) reporting requirements under the Kyoto Protocol. 
The GHG inventory helps in understanding the amount of GHGs emitted and what sectors they originate from. The Inventory covers the emissions of the following seven gases which contribute to global warming:

*	Carbon dioxide (CO<sub>2</sub>)
*	Methane (CH<sub>4</sub>)
*	Nitrous oxide (N<sub>2</sub>O)
*	Hydrofluorocarbons (HFCs)
*	Perfluorocarbons (PFCs)
*	Sulphur hexafluoride (SF<sub>6</sub>)
*	Nitrogen trifluoride (NF<sub>3</sub>)

The last four of these gases are the Fluorinated, or F-gases.

**Global Warming Potential:** Depending on their molecular weights, radiative properties and residence times in the atmosphere, each GHG has a different capacity to cause global warming. The Global warming potential, GWP, provides a measure of how much heat a GHG traps in the atmosphere, when that gas is compared to CO<sub>2</sub>. In order to compare emissions between GHGs consistently, each gas is weighted by its GWP. The GWP defines how potent a GHG is compared to CO<sub>2</sub> (which has a GWP of 1) while all other GHGs have larger GWPs, reflecting their greater global warming effect per unit.

**CO<sub>2</sub> Equivalent:** The values in this dashboard are presented in CO<sub>2</sub> equivalent units (CO<sub>2</sub>e). This is the emissions value, weighted using the appropriate GWP for the gas type. This standardises emissions from different gases, allowing comparison. More information on GWPs is available at: [UK greenhouse gas emissions: other technical reports](https://www.gov.uk/government/publications/uk-greenhouse-gas-emissions-explanatory-notes)

When comparing emissions over time, the ‘base year’ of 1990 is used for carbon dioxide, methane and nitrous oxide and 1995 for the fluorinated gases. When comparing emissions between England, Scotland, Wales and Northern Ireland in the comparisons tab, a log-scale is used. A log-scale allows data with a wide range of values to be compared on a single graph. 

**Replacement of National Communication sectors with Territorial Emissions Statistics sectors:**  Previous Northern Ireland Greenhouse Gas emissions statistics categorised emissions estimates into National Communication (NC) sectors. Following consultation with key stakeholders, it was proposed that the emissions estimates be categorised into Territorial Emissions Statistics (TES) sectors in order to better meet users' needs. A breakdown of how emissions sources from NC sectors have been reallocated to TES sectors is provided below.

TES Sector | Emissions sources in scope according to their NC sector allocation
------ | ------------------------
Agriculture | Agriculture – The coverage of the Agriculture sector is unchanged. However, there have been some changes to the categories within the Agriculture sector.
Buildings and Product Uses | Business - Includes emissions from combustion on commercial sites previously allocated to the Business sector. Also includes emissons from product uses in Business such as nitrous oxide (N2O) use as an anaesthetic, or stationary refrigeration and air conditioning.<br>Public - Includes all emissions previously allocated to the Public sector. <br>Residential - Includes emissions from residential fuel combustion and product uses such as recreational N2O use, aerosols, and metered dose inhalers previously allocated to the Residential sector. <br>Industrial Processes - Includes emissions from the use of N2O in industry previously allocated to the Industrial Processes sector. 
Domestic transport | Transport - includes all emissions previously allocated to the transport sector.<br>Business - Includes F-gas emissions from mobile air conditioning and transport refrigeration previously categorised as part of the Business sector.
Electricity Supply | Energy Supply - Includes emissions from power stations previously allocated to the Energy Supply sector.
Fuel Supply | Energy Supply - Includes emissions from fuel production and fuel supply activities such as mining, refining, manufacturing and distributing fuels previously allocated to the Energy Supply sector. 
Industry | Business - Most Industry sector emissions carry over from Business sector. These comrpise of emissions from manufacturing and construction, a well as industrial refrigeration and air conditioning. <br>Industrial Processes - Most emissions previously categorised as part of the Industrial processes sector have been reallocated to the Industry sector. <br>Energy Supply - Emissions from coke production previously categorised as part of the Energy supply sector have been reallocated to the Industry sector. 
Land use change | Land use change - The coverage of the land use change sector is unchanged. However there have been some substantial changes to the categories within the land use change sector to align better with land use poliyc. Key changes include separation of forestry and peatlands related emissions into their own sub-sectors, as well as the creation of new categories within forestry and peatlands that better describe the emissions and removals. 
Waste | Waste management - Includes all emissions prevously allocated to the Waste management sector.<br>Business  - Includes emissions from accidental fires previously allocated to the Business Sector. <br>Residential - Includes emissions from household composting, small-scale waste burning, and accidental fires previously allocated to the Residential sector. 
 
**Progress against draft ‘Programme for Government’ Wellbeing Framework:**  Greenhouse gas emissions have been included as an indicator under the ‘Cleaner Environment’ domain within the draft Programme for Government Wellbeing Framework. See [Programme for Government](https://www.executiveoffice-ni.gov.uk/topics/making-government-work/programme-government) for further information. 







### **META DATA**

**MetaData**

The data in this dashboard come from [Greenhouse Gas Inventories for England Scotland, Wales and Northern Ireland](https://naei.beis.gov.uk/reports/reports?report_id=1080)

The GHG inventory data are produced annually by Ricardo Energy and Environment, on behalf of the Department for Energy Security & Net Zero, the Scottish Government, the Welsh Assembly Government and the Northern Ireland Department of Agriculture, Environment and Rural Affairs. Each year the GHG inventory is extended and updated. The entire historical data series, from 1990 to the latest year, is revised to incorporate methodological improvements and new data. This takes into account revisions to the datasets used in its compilation.

The GHG emission estimates are based on a wide range of data sources and sources of uncertainty include statistical differences, assumptions, proxy datasets and expert judgement. In addition, the natural variability in the processes that are being modelled introduce uncertainty. For example, carbon content of fuels and farming practices under different climatic conditions and soil types. Uncertainty estimates for Northern Ireland emissions are available for the base year, the latest year (2022) and for the percentage change between the two years. For the base year, a close approximation of the 95% confidence interval is ±8%, and for 2022 it is ±6%. For the percentage reduction between the base year and 2021, the 95% confidence interval ranges from 20% to 37%.

There remains greater uncertainty around emissions in Northern Ireland compared to other parts of the United Kingdom due to the relative importance of methane and nitrous oxide emissions in the agriculture sector. Emissions of this gas are more difficult to estimate than carbon dioxide, and the agriculture sector makes up a larger share of Northern Ireland’s emissions than in other parts of the UK. More information is available in [An introduction to the UK’s greenhouse gas inventory](https://www.gov.uk/government/publications/uk-greenhouse-gas-emissions-statistics-user-guidance) and [UK Greenhouse Gas Emissions Statistics: FAQs](https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/996190/uk-emissions-statistics-frequently-asked-questions.pdf).



**Contact Details**

DAERA Statistics & Analytical Services Branch is keen to hear your feedback.

Please e-mail comments to env.stats@daera-ni.gov.uk

Further information can be found on the DAERA Statistics website https://www.daera-ni.gov.uk/landing-pages/statistics


**Date of Publication:**

Published: Annually

Time period covered – Greenhouse Gas Inventory: 1990-2022




<script>
 
 // Identifying all the download buttons in the document
var sliderMin = document.getElementsByClassName('irs-min');

// Loop to assign each filename in array to each button in document in order
for (var i=0; i<sliderMin.length; i++) {

  sliderMin.innerHTML = sliderMin.innerHTML.replace(/\s/g, '');

}
 
</script> 
